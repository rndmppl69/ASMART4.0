<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASMART 4.0 - Pengajuan Barang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: none;
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #4a6491;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        .btn-primary {
            background-color: #3498db;
            border: none;
            padding: 0.5rem 2rem;
        }
        .btn-success {
            background-color: #27ae60;
            border: none;
        }
        .btn-warning {
            background-color: #f39c12;
            border: none;
        }
        .table {
            background-color: white;
        }
        .required::after {
            content: " *";
            color: red;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1><i class="bi bi-box-seam"></i> ASMART 4.0</h1>
            <p class="lead">Sistem Pengajuan Barang Persediaan - KPPBC TMP C Manokwari</p>
        </div>
    </div>

    <div class="container">
        <!-- Form Pengajuan -->
        <div class="card" id="formSection">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-pencil-square"></i> Form Pengajuan Barang</h4>
            </div>
            <div class="card-body">
                <!-- Data Pegawai -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label required">Nama Seksi</label>
                        <select class="form-select" id="namaSeksi" required>
                            <option value="">Pilih Seksi</option>
                            <option value="Subbagian Umum">Subbagian Umum</option>
                            <option value="Penindakan dan Penyidikan (P2)">Penindakan dan Penyidikan (P2)</option>
                            <option value="Kepatuhan Internal dan Penyuluhan (KIP)">Kepatuhan Internal dan Penyuluhan (KIP)</option>
                            <option value="Pelayanan Kepabeanan dan Cukai dan Dukungan Teknis (PKCDT)">Pelayanan Kepabeanan dan Cukai dan Dukungan Teknis (PKCDT)</option>
                            <option value="Perbendaharaan">Perbendaharaan</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label required">Nama Pegawai</label>
                        <input type="text" class="form-control" id="nama" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label required">NIP</label>
                        <input type="text" class="form-control" id="nip" required>
                    </div>
                </div>

                <!-- Pilih Barang -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label required">Pilih Barang</label>
                        <select class="form-select" id="barangSelect">
                            <option value="">Pilih Barang...</option>
                            <!-- Barang akan diisi via JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label required">Jumlah</label>
                        <input type="number" class="form-control" id="jumlah" min="1" value="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Keterangan</label>
                        <input type="text" class="form-control" id="keterangan" placeholder="Contoh: Warna, Jenis, dll">
                    </div>
                </div>

                <!-- Tombol Tambah Barang -->
                <div class="mb-4">
                    <button class="btn btn-success" onclick="tambahBarang()">
                        <i class="bi bi-plus-circle"></i> Tambah ke Daftar
                    </button>
                    <button class="btn btn-warning" onclick="tambahBarangLain()">
                        <i class="bi bi-plus-lg"></i> Barang Lain (Tidak ada di list)
                    </button>
                </div>

                <!-- Daftar Barang yang Dipilih -->
                <div class="table-responsive">
                    <table class="table table-bordered" id="daftarBarang">
                        <thead class="table-light">
                            <tr>
                                <th>Nama Barang</th>
                                <th width="100">Jumlah</th>
                                <th>Keterangan</th>
                                <th width="80">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Barang akan ditambahkan di sini -->
                        </tbody>
                    </table>
                </div>

                <!-- Tombol Submit -->
                <div class="text-end mt-4">
                    <button class="btn btn-primary btn-lg" onclick="submitForm()">
                        <i class="bi bi-send"></i> Ajukan Permintaan
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Pengajuan -->
        <div class="card" id="statusSection" style="display: none;">
            <div class="card-header bg-success">
                <h4 class="mb-0"><i class="bi bi-check-circle"></i> Pengajuan Berhasil!</h4>
            </div>
            <div class="card-body text-center">
                <h3 class="text-success mb-4">
                    <i class="bi bi-check-circle-fill"></i> Permintaan Barang Telah Diajukan
                </h3>
                <p class="lead">Nomor Pengajuan: <strong id="nomorPengajuan">-</strong></p>
                <p>Silakan cek email Anda untuk konfirmasi dan tracking status pengajuan.</p>
                <button class="btn btn-primary" onclick="resetForm()">
                    <i class="bi bi-plus-circle"></i> Ajukan Barang Lagi
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Barang Lain -->
    <div class="modal fade" id="modalBarangLain" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Barang Lain</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label required">Nama Barang</label>
                        <input type="text" class="form-control" id="namaBarangLain">
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">Jumlah</label>
                        <input type="number" class="form-control" id="jumlahBarangLain" min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Keterangan</label>
                        <input type="text" class="form-control" id="keteranganBarangLain">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="tambahBarangLainSubmit()">Tambah</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // URL Google Apps Script Web App (GANTI DENGAN URL ANDA)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzhEqKS7_XI-Wruhgwd39lkIgXIUEzWkjxnewwjahivPXM-lFpugyuPBlAvomAum_u/exec";
        
        let daftarBarangDipilih = [];
        let barangList = [];

        // Inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            loadDaftarBarang();
        });

        // Load daftar barang dari Spreadsheet
        async function loadDaftarBarang() {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL + "?action=getBarang");
                const data = await response.json();
                
                if (data.success) {
                    barangList = data.data;
                    const select = document.getElementById('barangSelect');
                    
                    // Kosongkan dulu
                    select.innerHTML = '<option value="">Pilih Barang...</option>';
                    
                    // Tambahkan opsi barang
                    data.data.forEach(barang => {
                        const option = document.createElement('option');
                        option.value = barang.id;
                        option.textContent = `${barang.nama} (${barang.kategori}) - Stok: ${barang.stok}`;
                        option.setAttribute('data-satuan', barang.satuan);
                        select.appendChild(option);
                    });
                    
                    // Tambahkan opsi barang lain
                    const optionLain = document.createElement('option');
                    optionLain.value = "lainnya";
                    optionLain.textContent = "--- Barang Lain (Tidak ada di list) ---";
                    select.appendChild(optionLain);
                }
            } catch (error) {
                console.error('Error loading barang:', error);
                alert('Gagal memuat daftar barang. Silakan refresh halaman.');
            } finally {
                showLoading(false);
            }
        }

        // Tambah barang yang dipilih ke daftar
        function tambahBarang() {
            const barangSelect = document.getElementById('barangSelect');
            const jumlah = document.getElementById('jumlah').value;
            const keterangan = document.getElementById('keterangan').value;
            
            if (!barangSelect.value) {
                alert('Pilih barang terlebih dahulu!');
                return;
            }
            
            if (!jumlah || jumlah < 1) {
                alert('Jumlah harus diisi dengan angka positif!');
                return;
            }
            
            // Cari data barang
            const barang = barangList.find(b => b.id == barangSelect.value);
            
            if (!barang) {
                alert('Barang tidak ditemukan!');
                return;
            }
            
            // Tambahkan ke array
            daftarBarangDipilih.push({
                id: barang.id,
                nama: barang.nama,
                jumlah: parseInt(jumlah),
                keterangan: keterangan,
                satuan: barang.satuan
            });
            
            // Update tabel
            updateTabelBarang();
            
            // Reset form
            barangSelect.value = '';
            document.getElementById('jumlah').value = 1;
            document.getElementById('keterangan').value = '';
        }

        // Tambah barang lain
        function tambahBarangLain() {
            // Reset modal
            document.getElementById('namaBarangLain').value = '';
            document.getElementById('jumlahBarangLain').value = 1;
            document.getElementById('keteranganBarangLain').value = '';
            
            // Tampilkan modal
            const modal = new bootstrap.Modal(document.getElementById('modalBarangLain'));
            modal.show();
        }

        // Submit barang lain
        function tambahBarangLainSubmit() {
            const nama = document.getElementById('namaBarangLain').value;
            const jumlah = document.getElementById('jumlahBarangLain').value;
            const keterangan = document.getElementById('keteranganBarangLain').value;
            
            if (!nama) {
                alert('Nama barang harus diisi!');
                return;
            }
            
            if (!jumlah || jumlah < 1) {
                alert('Jumlah harus diisi dengan angka positif!');
                return;
            }
            
            // Tambahkan ke array
            daftarBarangDipilih.push({
                id: 'lainnya',
                nama: nama,
                jumlah: parseInt(jumlah),
                keterangan: keterangan,
                satuan: 'Pcs'
            });
            
            // Update tabel
            updateTabelBarang();
            
            // Tutup modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalBarangLain'));
            modal.hide();
        }

        // Update tabel barang yang dipilih
        function updateTabelBarang() {
            const tbody = document.querySelector('#daftarBarang tbody');
            tbody.innerHTML = '';
            
            if (daftarBarangDipilih.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada barang yang dipilih</td></tr>';
                return;
            }
            
            daftarBarangDipilih.forEach((barang, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${barang.nama}</td>
                    <td>${barang.jumlah} ${barang.satuan}</td>
                    <td>${barang.keterangan || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="hapusBarang(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Hapus barang dari daftar
        function hapusBarang(index) {
            daftarBarangDipilih.splice(index, 1);
            updateTabelBarang();
        }

        // Submit form ke Google Apps Script
        async function submitForm() {
            // Validasi form
            const namaSeksi = document.getElementById('namaSeksi').value;
            const nama = document.getElementById('nama').value;
            const nip = document.getElementById('nip').value;
            
            if (!namaSeksi || !nama || !nip) {
                alert('Harap lengkapi data pegawai terlebih dahulu!');
                return;
            }
            
            if (daftarBarangDipilih.length === 0) {
                alert('Tambahkan minimal satu barang ke daftar!');
                return;
            }
            
            showLoading(true);
            
            const data = {
                action: 'submitPengajuan',
                namaSeksi: namaSeksi,
                nama: nama,
                nip: nip,
                barang: daftarBarangDipilih
            };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Mode no-cors untuk Google Apps Script
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                // Karena menggunakan no-cors, kita tidak bisa membaca response langsung
                // Alternatif: Gunakan metode GET dengan parameter URL
                await submitViaGet(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan. Silakan coba lagi.');
            } finally {
                showLoading(false);
            }
        }

        // Alternatif submit menggunakan GET (karena Apps Script punya batasan CORS)
        async function submitViaGet(data) {
            // Buat parameter URL
            let params = `action=submitPengajuan`;
            params += `&namaSeksi=${encodeURIComponent(data.namaSeksi)}`;
            params += `&nama=${encodeURIComponent(data.nama)}`;
            params += `&nip=${encodeURIComponent(data.nip)}`;
            params += `&barang=${encodeURIComponent(JSON.stringify(data.barang))}`;
            
            try {
                const response = await fetch(SCRIPT_URL + "?" + params);
                const result = await response.json();
                
                if (result.success) {
                    // Tampilkan status sukses
                    document.getElementById('formSection').style.display = 'none';
                    document.getElementById('nomorPengajuan').textContent = result.noPengajuan;
                    document.getElementById('statusSection').style.display = 'block';
                } else {
                    alert('Gagal mengajukan: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Pengajuan berhasil, tetapi ada masalah dengan respons server.');
                // Tetap anggap sukses untuk UX
                document.getElementById('formSection').style.display = 'none';
                document.getElementById('statusSection').style.display = 'block';
            }
        }

        // Reset form untuk pengajuan baru
        function resetForm() {
            // Reset semua field
            document.getElementById('namaSeksi').value = '';
            document.getElementById('nama').value = '';
            document.getElementById('nip').value = '';
            document.getElementById('barangSelect').value = '';
            document.getElementById('jumlah').value = 1;
            document.getElementById('keterangan').value = '';
            
            // Kosongkan daftar barang
            daftarBarangDipilih = [];
            updateTabelBarang();
            
            // Tampilkan form lagi
            document.getElementById('statusSection').style.display = 'none';
            document.getElementById('formSection').style.display = 'block';
        }

        // Tampilkan/sembunyikan loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
