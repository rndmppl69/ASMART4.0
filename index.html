<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASMART 4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: Arial; }
        .header { background: linear-gradient(135deg, #2c3e50, #4a6491); color: white; padding: 20px 0; }
        .card { border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="mt-2" id="loadingText">Memuat...</div>
    </div>

    <div class="header">
        <div class="container">
            <h1>ASMART 4.0</h1>
            <p class="lead mb-0">Sistem Pengajuan Barang Persediaan</p>
        </div>
    </div>

    <div class="container mt-4">
        <!-- URL Info -->
        <div class="alert alert-info mb-3">
            <small>
                <strong>Status:</strong> 
                <span id="statusText">Menyiapkan sistem...</span>
                <button class="btn btn-sm btn-outline-primary float-end" onclick="testConnection()">Test Koneksi</button>
            </small>
        </div>

        <!-- Form Section -->
        <div class="card" id="formSection">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Form Pengajuan Barang</h4>
            </div>
            <div class="card-body">
                <!-- Data Pegawai -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Nama Seksi *</label>
                        <select class="form-select" id="namaSeksi" required>
                            <option value="">Pilih Seksi</option>
                            <option value="Subbagian Umum">Subbagian Umum</option>
                            <option value="Penindakan dan Penyidikan (P2)">Penindakan dan Penyidikan (P2)</option>
                            <option value="Kepatuhan Internal dan Penyuluhan (KIP)">Kepatuhan Internal dan Penyuluhan (KIP)</option>
                            <option value="Pelayanan Kepabeanan dan Cukai dan Dukungan Teknis (PKCDT)">Pelayanan Kepabeanan dan Cukai dan Dukungan Teknis (PKCDT)</option>
                            <option value="Perbendaharaan">Perbendaharaan</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nama Pegawai *</label>
                        <input type="text" class="form-control" id="nama" placeholder="Masukkan nama" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">NIP *</label>
                        <input type="text" class="form-control" id="nip" placeholder="Masukkan NIP" required>
                    </div>
                </div>

                <!-- Pilih Barang -->
                <div class="row mb-3">
                    <div class="col-md-5">
                        <label class="form-label">Pilih Barang *</label>
                        <select class="form-select" id="barangSelect">
                            <option value="">Memuat daftar barang...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Jumlah *</label>
                        <input type="number" class="form-control" id="jumlah" min="1" value="1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Keterangan</label>
                        <input type="text" class="form-control" id="keterangan" placeholder="Warna, jenis, dll">
                    </div>
                </div>

                <div class="mb-3">
                    <button class="btn btn-success" onclick="tambahBarang()">
                        <i class="bi bi-plus-circle"></i> Tambah ke Daftar
                    </button>
                    <button class="btn btn-warning" onclick="tambahBarangLain()">
                        <i class="bi bi-plus-lg"></i> Barang Lain
                    </button>
                </div>

                <!-- Daftar Barang -->
                <div class="table-responsive mb-4">
                    <table class="table table-bordered" id="daftarBarang">
                        <thead class="table-light">
                            <tr>
                                <th>Nama Barang</th>
                                <th width="100">Jumlah</th>
                                <th>Keterangan</th>
                                <th width="80">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="barangBody">
                            <tr>
                                <td colspan="4" class="text-center text-muted">Belum ada barang yang dipilih</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="text-end">
                    <button class="btn btn-primary btn-lg" onclick="submitForm()">Ajukan Permintaan</button>
                </div>
            </div>
        </div>

        <!-- Success Section -->
        <div class="card" id="successSection" style="display: none;">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Pengajuan Berhasil!</h4>
            </div>
            <div class="card-body text-center">
                <h3 class="text-success mb-3">✓ Permintaan Telah Diajukan</h3>
                <p>Nomor Pengajuan: <strong id="nomorPengajuan"></strong></p>
                <p id="successMessage"></p>
                <button class="btn btn-primary" onclick="resetForm()">Ajukan Lagi</button>
            </div>
        </div>

        <!-- Error Section -->
        <div class="card" id="errorSection" style="display: none;">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0">Terjadi Kesalahan</h4>
            </div>
            <div class="card-body text-center">
                <h3 class="text-danger mb-3">✗ Gagal Mengajukan</h3>
                <p id="errorMessage"></p>
                <button class="btn btn-primary" onclick="resetForm()">Coba Lagi</button>
            </div>
        </div>
    </div>

    <!-- Modal Barang Lain -->
    <div class="modal fade" id="modalBarangLain">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Barang Lain</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nama Barang *</label>
                        <input type="text" class="form-control" id="namaBarangLain">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jumlah *</label>
                        <input type="number" class="form-control" id="jumlahBarangLain" min="1" value="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Keterangan</label>
                        <input type="text" class="form-control" id="keteranganBarangLain">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="tambahBarangLainSubmit()">Tambah</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== KONFIGURASI ====================
        // GANTI URL INI DENGAN URL WEB APP ANDA
        let SCRIPT_URL = "https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec";
        
        // Cek jika ada URL yang disimpan di localStorage
        if (localStorage.getItem('asmart_url')) {
            SCRIPT_URL = localStorage.getItem('asmart_url');
        } else {
            // Minta URL jika belum ada
            const savedUrl = prompt("Masukkan URL Web App Google Apps Script Anda:", SCRIPT_URL);
            if (savedUrl) {
                SCRIPT_URL = savedUrl;
                localStorage.setItem('asmart_url', SCRIPT_URL);
            }
        }
        
        document.getElementById('statusText').textContent = 'Menggunakan URL: ' + SCRIPT_URL.substring(0, 50) + '...';
        
        let daftarBarangDipilih = [];
        let barangList = [];

        // ==================== INISIALISASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ASMART 4.0 loaded');
            console.log('Script URL:', SCRIPT_URL);
            loadDaftarBarang();
        });

        // ==================== FUNGSI BARANG ====================
        async function loadDaftarBarang() {
            showLoading('Memuat daftar barang...');
            
            try {
                const url = SCRIPT_URL + '?action=getBarang&t=' + Date.now();
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Barang data:', result);
                
                if (result.success && result.data) {
                    barangList = result.data;
                    updateBarangSelect();
                    document.getElementById('statusText').textContent = 'Sistem siap. ' + barangList.length + ' barang tersedia.';
                } else {
                    throw new Error(result.message || 'Data tidak valid');
                }
                
            } catch (error) {
                console.error('Error loading barang:', error);
                // Gunakan data fallback
                useFallbackData();
                document.getElementById('statusText').textContent = 'Menggunakan data lokal: ' + error.message;
            } finally {
                showLoading(false);
            }
        }

        function useFallbackData() {
            barangList = [
                { id: 1, nama: 'Balliner', kategori: 'ATK', satuan: 'Pak', stok: 100 },
                { id: 2, nama: 'Spidol', kategori: 'ATK', satuan: 'Pak', stok: 50 },
                { id: 3, nama: 'Toner Printer', kategori: 'Elektronik', satuan: 'Pcs', stok: 20 },
                { id: 4, nama: 'Tissue', kategori: 'Kebersihan', satuan: 'Pcs', stok: 200 },
                { id: 5, nama: 'Kertas A4', kategori: 'ATK', satuan: 'Rim', stok: 30 },
                { id: 6, nama: 'Kertas F4', kategori: 'ATK', satuan: 'Rim', stok: 25 },
                { id: 7, nama: 'Pengharum Ruangan', kategori: 'Kebersihan', satuan: 'Pcs', stok: 40 },
                { id: 8, nama: 'Paper Clip', kategori: 'ATK', satuan: 'Box', stok: 15 },
                { id: 9, nama: 'Stapler', kategori: 'ATK', satuan: 'Pcs', stok: 10 },
                { id: 10, nama: 'Isi Stapler', kategori: 'ATK', satuan: 'Box', stok: 20 }
            ];
            
            updateBarangSelect();
        }

        function updateBarangSelect() {
            const select = document.getElementById('barangSelect');
            select.innerHTML = '<option value="">Pilih Barang...</option>';
            
            barangList.forEach(barang => {
                const option = document.createElement('option');
                option.value = barang.id;
                option.textContent = `${barang.nama} - Stok: ${barang.stok}`;
                option.setAttribute('data-satuan', barang.satuan);
                select.appendChild(option);
            });
            
            // Tambah opsi barang lain
            const optionLain = document.createElement('option');
            optionLain.value = "lainnya";
            optionLain.textContent = "--- Barang Lain ---";
            select.appendChild(optionLain);
        }

        function tambahBarang() {
            const select = document.getElementById('barangSelect');
            const jumlah = document.getElementById('jumlah').value;
            const keterangan = document.getElementById('keterangan').value;
            
            if (!select.value) {
                alert('Pilih barang terlebih dahulu!');
                return;
            }
            
            if (select.value === 'lainnya') {
                tambahBarangLain();
                return;
            }
            
            if (!jumlah || jumlah < 1) {
                alert('Jumlah harus angka positif!');
                return;
            }
            
            const barang = barangList.find(b => b.id == select.value);
            if (!barang) {
                alert('Barang tidak ditemukan!');
                return;
            }
            
            daftarBarangDipilih.push({
                id: barang.id,
                nama: barang.nama,
                jumlah: parseInt(jumlah),
                keterangan: keterangan,
                satuan: barang.satuan
            });
            
            updateTabelBarang();
            
            // Reset
            select.value = '';
            document.getElementById('jumlah').value = 1;
            document.getElementById('keterangan').value = '';
        }

        function tambahBarangLain() {
            document.getElementById('namaBarangLain').value = '';
            document.getElementById('jumlahBarangLain').value = 1;
            document.getElementById('keteranganBarangLain').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('modalBarangLain'));
            modal.show();
        }

        function tambahBarangLainSubmit() {
            const nama = document.getElementById('namaBarangLain').value;
            const jumlah = document.getElementById('jumlahBarangLain').value;
            const keterangan = document.getElementById('keteranganBarangLain').value;
            
            if (!nama.trim()) {
                alert('Nama barang harus diisi!');
                return;
            }
            
            if (!jumlah || jumlah < 1) {
                alert('Jumlah harus angka positif!');
                return;
            }
            
            daftarBarangDipilih.push({
                id: 'lainnya',
                nama: nama,
                jumlah: parseInt(jumlah),
                keterangan: keterangan,
                satuan: 'Pcs'
            });
            
            updateTabelBarang();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalBarangLain'));
            modal.hide();
        }

        function updateTabelBarang() {
            const tbody = document.getElementById('barangBody');
            
            if (daftarBarangDipilih.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada barang yang dipilih</td></tr>';
                return;
            }
            
            let html = '';
            daftarBarangDipilih.forEach((barang, index) => {
                html += `
                    <tr>
                        <td>${barang.nama}</td>
                        <td>${barang.jumlah} ${barang.satuan}</td>
                        <td>${barang.keterangan || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="hapusBarang(${index})">
                                Hapus
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function hapusBarang(index) {
            daftarBarangDipilih.splice(index, 1);
            updateTabelBarang();
        }

        // ==================== FUNGSI FORM ====================
        async function submitForm() {
            const namaSeksi = document.getElementById('namaSeksi').value;
            const nama = document.getElementById('nama').value;
            const nip = document.getElementById('nip').value;
            
            // Validasi
            if (!namaSeksi || !nama || !nip) {
                alert('Lengkapi semua data pegawai!');
                return;
            }
            
            if (daftarBarangDipilih.length === 0) {
                alert('Tambahkan minimal satu barang!');
                return;
            }
            
            showLoading('Mengirim pengajuan...');
            
            // Siapkan data
            const data = {
                namaSeksi: namaSeksi,
                nama: nama,
                nip: nip,
                barang: JSON.stringify(daftarBarangDipilih)
            };
            
            try {
                // Encode sebagai URL parameters
                let params = `action=submitPengajuan`;
                params += `&namaSeksi=${encodeURIComponent(data.namaSeksi)}`;
                params += `&nama=${encodeURIComponent(data.nama)}`;
                params += `&nip=${encodeURIComponent(data.nip)}`;
                params += `&barang=${encodeURIComponent(data.barang)}`;
                params += `&t=${Date.now()}`;
                
                const url = SCRIPT_URL + '?' + params;
                console.log('Submitting to:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                console.log('Response:', result);
                
                if (result.success) {
                    showSuccess(result.data);
                } else {
                    throw new Error(result.message || 'Gagal mengajukan');
                }
                
            } catch (error) {
                console.error('Submit error:', error);
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        async function testConnection() {
            showLoading('Menguji koneksi...');
            
            try {
                const url = SCRIPT_URL + '?action=test&t=' + Date.now();
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Koneksi berhasil!\n\n' + 
                          'Web App berjalan normal.\n' +
                          'Timestamp: ' + result.data.timestamp);
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                alert('❌ Koneksi gagal!\n\nError: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function showSuccess(data) {
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            
            document.getElementById('nomorPengajuan').textContent = data.noPengajuan || 'TEST-' + Date.now();
            document.getElementById('successMessage').textContent = data.message || 'Pengajuan berhasil diterima';
            document.getElementById('successSection').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('successSection').style.display = 'none';
            
            document.getElementById('errorMessage').textContent = message || 'Terjadi kesalahan yang tidak diketahui';
            document.getElementById('errorSection').style.display = 'block';
        }

        function resetForm() {
            // Reset form
            document.getElementById('namaSeksi').value = '';
            document.getElementById('nama').value = '';
            document.getElementById('nip').value = '';
            document.getElementById('barangSelect').value = '';
            document.getElementById('jumlah').value = 1;
            document.getElementById('keterangan').value = '';
            
            // Reset daftar
            daftarBarangDipilih = [];
            updateTabelBarang();
            
            // Tampilkan form lagi
            document.getElementById('successSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('formSection').style.display = 'block';
        }

        function showLoading(message) {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            
            if (message) {
                loading.style.display = 'flex';
                loadingText.textContent = message;
            } else {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
